<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>WiFi-Location Analytics</title>
    <link
        href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
        rel="stylesheet">
    
    <!-- IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  
    <style>
      
      circle {
        stroke: #7289D3;
        stroke-width: 1px;
      }
     
      circle:hover {
        stroke: #596CA3;
        stroke-width: 2px;
      }
              
      text {
        text-anchor: middle;
        font-size: 13px;
        cursor: default;
      }
      
      .node text {
        opacity: 0;
      }

      .node:hover text {
        opacity: 1;
      }

    </style>
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
          <div id="visual"></div>
        </div>
      </div>
    </div>
  
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>

var w, h, svg, scales;
var window_size = 10;
var refresh_interval = 5000;
var devices = {};
var endpoint = "http://explore.meyersj.com:8005/query?window=" + window_size;

$(document).ready(function() {
    w = $("#visual").outerWidth();
    h = window.innerHeight;
    svg = canvas("#visual");
    add_legend(svg);
    runner();
    setInterval(function() { runner(); }, refresh_interval);
});

function canvas(div) {
    if(svg) svg.remove();
    return d3.select(div)
        .append("svg")
        .attr("height", h)
        .attr("width", w);
}

function add_legend(svg) {
    svg.append("circle")
        .style("fill", "#FFFFFF")
        .attr('r', Math.min(h/2, w/2) - 25) 
        .attr('cx', w/2)
        .attr('cy', h/2);
}

function build_scales(dataset) {
    var rad = Math.PI * 2;
    var offset = rad / 8;
    return {
        duration:d3.scale.linear()
            .domain([0, window_size])
            .range([7, 25]),
        age:d3.scale.pow().exponent(1/2)
            .domain([0, window_size])
            .range(["blue", "white"]),
        signal:d3.scale.log().base(2)
            .range([50, Math.min(h/2, w/2) - 25])
            .domain([
                d3.min(dataset, function(d) { return d.AvgSignal; }),
                d3.max(dataset, function(d) { return d.AvgSignal; })
            ]),
        age_radius:d3.scale.linear()
            .domain([0, window_size])
            .range([0 - offset, rad - (offset * 3)])
    };
}

function runner() {
    $.getJSON(endpoint, function(data) {
        var dataset = merge_data(devices, data.Data);
        var nodes = svg.selectAll('.node')
            .data(dataset, function(d) {
                return d.Mac;
            });
        console.log("enter");
        scales = build_scales(dataset)    
        visualize(data, nodes);
    });
}

function merge_data(devices, data) {
    $.each(data, function(i, d) {
        devices[d.Mac] = d;
        console.log(d.AvgSignal);
    });
    var dataset = []
    for (var key in devices) {
        dataset.push(devices[key]);
    }
    dataset.sort(function(a, b) {
        return a.LastArrival - b.LastArrival;
    });
    dataset.unshift({x:w/2, y:h/2, fixed:true, Mac:"Centroid"});
    return dataset; 
}

function visualize(data, nodes) { 

    function getDuration(d) {
        return (d.LastArrival - d.FirstArrival) / 60;
    }

    function getAge(d) {
        return (data.Start + (data.Window * 60) - d.LastArrival) / 60;
    }

    function computeX(d, mag) {
        return Math.cos(scales.age_radius(getAge(d))) * mag;
    }
    
    function computeY(d, mag) {
        return Math.sin(scales.age_radius(getAge(d))) * mag;
    }

    function fill(d) {
        if (d.fixed) return "#828296";
        return scales.age(getAge(d));
    }

    function radius(d) {
        if (d.fixed) return 10;
        return scales.duration(getDuration(d));
    }
    
    function circleX(d) {
        if (d.fixed) return d.x;
        return w/2 + computeX(d, scales.signal(d.AvgSignal));
    }

    function circleY(d) {
        if (d.fixed) return d.y;
        return h/2 + computeY(d, scales.signal(d.AvgSignal));
    }
    
    var group = nodes.enter().append("g")
        .attr("class", "node")
        .attr("mac", function(d) {
            return d.Mac;
        })
        .attr('x', circleX)
        .attr('y', circleY);

    group.append("text")
        .attr('x', circleX)
        .attr('y', circleY)
        .text(function(d) { return d.Mac; })
        .style("font-family", "sans-serif")
        .style("font-size", "20px")
        .style("fill", "red");
    
    group.append("circle")
        .style('fill', fill)
        .attr('r', radius)
        .attr('cx', circleX)
        .attr('cy', circleY);

    group.select("circle")
        .transition()
        .duration(refresh_interval)
        .style('fill', fill)
        .attr('r', radius)
        .attr('cx', circleX)
        .attr('cy', circleY);
  
    nodes.exit().remove();
}

    </script>
  </body>
</html>
