<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>WiFi-Location Analytics</title>
    <link
        href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
        rel="stylesheet">
    
    <!-- IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  
    <style>
      circle {
        stroke: #7289D3;
        stroke-width: 1px;
      }
     
      circle:hover {
        stroke: #596CA3;
        stroke-width: 2px;
      }
              
      text {
        text-anchor: middle;
        font-size: 13px;
        cursor: default;
      }
      
      .node text {
        opacity: 0;
      }

      .node:hover text {
        opacity: 1;
      }
    </style>
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
          <div id="visual"></div>
        </div>
      </div>
    </div>
  
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="cache.js"></script>
    <script>

var w, h, svg, active
var scales = {};
var window_size = 10;
var interval = 5000;
var hourDataCache = new DataCache();;
var devices = {};
var base_url = "http://explore.meyersj.com:8005"
var query_endpoint = base_url + "/query";
var hour_endpoint = base_url + "/hour";

$(document).ready(function() {
    w = $("#visual").outerWidth();
    console.log(w);
    h = window.innerHeight;
    svg = canvas("#visual");
    scales.duration = buildDurationScale(window_size);
    scales.scaleX = buildXScale();
    update();
    setInterval(function() { update(); }, interval);
});

function canvas(div) {
    if(svg) svg.remove();
    return d3.select(div)
        .append("svg")
        .attr("height", h)
        .attr("width", w);
}

function buildAgeScale(start) {
    return d3.scale.pow().exponent(1/2)
        .domain([start + (window_size * 60), start])
        .range(["blue", "white"]);
}

function buildDurationScale(window_size) {
    return d3.scale.linear()
        .domain([0, window_size * 60])
        .range([5, 15]);
}

function buildXScale() {
    return d3.scale.linear()
        .domain([-30, -100])
        .range([0 + 20, w - 20]);
}

function buildYScale(start) {
    return d3.scale.linear()
        .domain([start, start + (60 * window_size)])
        .range([h - 20, 0 + 20]);
}

function buildHourXScale(start_time) {
    return d3.scale.linear()
        .domain([start_time, start_time + 3600 - 360])
        .range([0 + 20, w - 20]);
}

function mouseoverNode(d) {
    toggleHourSummary(d);
}

function mouseoutNode(d) {
    var nodes = svg.selectAll(".hour-data-point");
    nodes.selectAll("*").remove();
    nodes.transition().remove();
}

function drawHourSummary(mac, data) {
    var xScale = buildHourXScale(data.Start)
    var nodes = svg.selectAll(".hour-data-point")
        .data(data.Data)
        .enter()
        .append("g")
        .attr("class", "hour-data-point")
        .attr("mac", function(d) {
            return d.Mac     
        })
        .append("circle")
        .attr('fill', "black")
        .attr('r', function(d) {
            return d.PingCount * 2;
        })
        .attr('cx', function(d) {
            return xScale(d.Bucket);
        })
        .attr('cy', function(d) {
            return h - 30;
        });
}

function toggleHourSummary(d) {
    var cache = hourDataCache.get(d.Mac);
    if (cache == null) {
        // download and update cache
        $.getJSON(hour_endpoint, {mac:d.Mac}, function(data) {
            hourDataCache.add(d.Mac, data, 360);
            drawHourSummary(d.Mac, data)
            active = d.Mac;
        });
    }
    else {
        // use cached data
        drawHourSummary(d.Mac, cache)
        active = d.Mac;
    }
}

function update() {
    $.getJSON(query_endpoint, {"window":window_size}, function(data) {
        var dataset = merge(devices, data.Start, data.Data);
        scales.age = buildAgeScale(data.Start);
        scales.scaleY = buildYScale(data.Start);
        visualize(dataset);
    });
}

function merge(devices, start, data) {
    var dataset = []
    $.each(data, function(i, d) {
        devices[d.Mac] = d;
    });
    for (var key in devices) {
        // expire old devices
        if (devices[key].LastArrival < start) {
            delete devices[key];
        }
        else {
            dataset.push(devices[key]);
        }
    }
    dataset.sort(function(a, b) {
        return a.LastArrival - b.LastArrival;
    });
    return dataset; 
}

function visualize(data) {

    var nodes = svg.selectAll(".node")
        .data(data, function(d) {
            return d.Mac;        
        });

    var group = nodes.enter().append("g")
        .attr("class", "node")
        .attr("mac", function(d) {
            return d.Mac;
        });
        
    group.append("circle")
        .attr('fill', function(d) { 
            return scales.age(d.LastArrival);
        })
        .on("mouseover", mouseoverNode)
        .on("mouseout", mouseoutNode);

    /*
    group.append("text");
        
    group.select("text").transition().duration(interval)
        .attr('x', function(d) {
            return scales.scaleX(d.AvgSignal);
        })
        .attr('y', function(d) {
            return scales.scaleY(d.LastArrival) - 15;
        })
        .text(function(d) { return d.Mac; });
    */

    group.select("circle").transition().duration(interval)
        .attr('fill', function(d) {
            return scales.age(d.LastArrival);
        })
        .attr('r', function(d) {
            return scales.duration(d.LastArrival - d.FirstArrival);
        })
        .attr('cx', function(d) {
            return scales.scaleX(d.AvgSignal);
        })
        .attr('cy', function(d) {
            return scales.scaleY(d.LastArrival);
        });

    nodes.exit().remove();
}

    </script>
  </body>
</html>
