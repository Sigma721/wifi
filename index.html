<html>
  <head>
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js">
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
            <h3>visitors around my apartment (based on wifi activity)</h3>
            <p>
              <a href="https://github.com/meyersj/wifi">github repository</a>
              <br>
              <br>
              The data is collected using a Raspberry Pi and packaged up and
              sent to a virtual machine running a python
              <a href="http://flask.pocoo.org/">Flask</a>
              web-app. That app will process the data and insert into a
              <a href="http://cassandra.apache.org/">Cassandra</a>
              cluster (1 node). There is a then cron job that will
              process the recent data in one minute batches and group it into
              <strong>visits</strong> per device.
            </p>
            <form class="form-inline" style="padding-top:5px;">
              <div class="form-group">
                <label for="input-age">Window (min)</label>
                <input type="number" min="15" max="120" class="form-control input-sm"
                  id="input-age" placeholder="30">
              </div>
              <div class="form-group" style="padding-left:5px;padding-right:5px;">
                <label for="input-activity">Rate (minutes active/hour)</label>
                <input type="number" min="1" max="60"class="form-control input-sm"
                  id="input-activity" placeholder="15">
              </div>
              <button id="btn-update" type="submit"
                class="btn btn-default">Update</button>
            </form>
          </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 main">
          <div id="visual"></div>
        </div>
      </div>
    </div>
  <script>
    var base_url = "http://wifi.meyersj.com";
    var h = null;
    var w = null;
    var svg = null;

    function draw(age, rate) {
      svg.selectAll("path")
        .transition()
        .style("opacity",0)
        .duration(1000);
      svg.selectAll("circle")
        .transition()
        .style("opacity",0)
        .duration(1000);
      svg.selectAll("text[lab=duration]")
        .transition()
        .style("opacity",0)
        .duration(1000);
      
      var args = {};
      args["location"] = "apartment";
      args["age"] = age;
      args["rate"] = rate;
      console.log(args);
      
      $.getJSON(base_url + "/visits", args, function(data) {
        svg.selectAll("*").remove();
        var end = (new Date).getTime() / 1000;
        var start = end - (age * 60);
        
        var left = 150; // padding
        var time_scale = d3.scale.linear()
          .domain([start, end])
          .range([left, w - 200]);
        var incr = h / (data.visits.length + 1);
        var level = incr;
        var devices = [];
        var pings = []
        $(data.visits).each(function(index, item) {
            if(item.first_arrival < start) var low = left;
            else var low = time_scale(item.first_arrival);
            var high = time_scale(item.recent_arrival);
            pings.push({x:low, y:level});
            pings.push({x:high, y:level});
            $(item.data).each(function(index2, item2) {
              var ping = time_scale(item2[0]);
              pings.push({x:ping, y:level});
            });
            var line = [
                {
                    x:low,
                    y:level,
                    id:item.device,
                    mac:item.mac,
                    duration:item.duration
                },
                {
                    x:high,
                    y:level
                },
            ];
            devices.push(line);
            level += incr;

        });
        
        var line = d3.svg.line()
          .x(function(d, i) {
            return d.x;
          })
          .y(function(d, i) {
            return d.y;
          });

        var visit_lines = svg.selectAll("path")
          .data(devices).enter()
          .append("path")
          .attr("d", function(d) { 
            return line(d);
          })
          .attr("stroke", "black")
          .attr("stroke-width", 1);
        
        var ping_circles = svg.selectAll("circle[d=ping]")
          .data(pings).enter()
          .append("circle")
          .attr("d", "ping")
          .attr("cx", function(d) {
             return d.x;
          })
          .attr("cy", function(d) {
             return d.y;
          })
          .attr("r", 3)
          .style("fill", "black");
      
        if(data.visits.length < 35) { 
          
          svg.append("circle")
            .attr("cx", w - 190) 
            .attr("cy", 10) 
            .attr("r", 7)
            .style("fill", "green")
          
          svg.append("text")
            .text("click to see visitor's history")
            .attr("x", w - 180)
            .attr("y", 14) 
            .attr("font-size", "10px");

          var circles = svg.selectAll("circle[d=end]")
            .data(devices).enter()
            .append("circle")
            .attr("d", "end")
            .attr("cx", function(d) {
                 return d[1].x - 11;
            })
            .attr("cy", function(d) {
                return d[0].y;
            })
            .attr("r", 7)
            .style("fill", "green")
            .on("click", function(d) {
                var args = {mac:d[0].mac};
                $.getJSON(base_url + "/visitor-history", args, function(data) {
                    console.log(data);
                    svg.selectAll("text[lab=visit]").remove();
                    
                    svg.selectAll("text[lab=active-device]").remove()
                    svg.append("text")
                      .attr("lab", "active-device")
                      .text(data.device)
                      .attr("x", w - 180)
                      .attr("y", 40);
                    
                    svg.selectAll("text[lab=visit]")
                      .data(data.visits).enter()
                      .append("text")
                      .attr("lab", "visit")
                      .attr("font-size", "10px")
                      .each(function(d2, i) {
                        var visit = d3.select(this);
                        console.log(visit);
                        var section = 60 + i * 40;
                        visit.append("tspan")
                          .text("start: " + d2.start_stamp)
                          .attr("x", w - 190)
                          .attr("y", section)
                        visit.append("tspan")
                          .text("end: " + d2.end_stamp)
                          .attr("x", w - 190)
                          .attr("y", section + 10);
                        visit.append("tspan")
                          .text("duration: " + d2.stamp)
                          .attr("x", w - 190)
                          .attr("y", section + 20);
                      });
                });
            });
        
          var durationLabel = svg.selectAll("text[lab=duration]")
            .data(devices).enter()
            .append("text")
            .attr("lab", "duration")
            .text(function(d) {
              return d[0].duration + " " + d[0].id;
            })
            .attr("x", function(d) {
              return 0;
            })
            .attr("y", function(d) {
              return d[0].y + 4;
            })
            .attr("font-size", "10px");

        }
      });
    }


    $(document).ready(function() {
      w = $("#visual").outerWidth();
      h = document.body.clientHeight * 0.65;
      svg = create_canvas("#visual", h, w);
      draw(30, 15);



    });
 
    function create_canvas(div, height, width) {
      return d3.select(div)
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    }

    $("#btn-update").click( function(event) {
      var age = $("#input-age").val() || 30;
      var activity = $("#input-activity").val() || 15;
      event.preventDefault();
      draw(age, activity);
    });    



  </script>





  </body>
</html>
