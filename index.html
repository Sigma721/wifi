<html>
  <head>
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js">
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
            <h2>Wi-Fi Activity <small>visitors around my apartment</small></h3>
            <br>
            <a class="btn btn-default" href="architecture.html"
              role="button">System Architecture</a>
            <a class="btn btn-default" href="https://github.com/meyersj/wifi"
              role="button">Github Repository</a>
            <br><br>
            <p>
            When the page has loaded, click on a device label to
            view history of previous visits.
            <br>
            </p>
            <form class="form-inline" style="padding-top:5px;">
              <div class="form-group">
                <label for="input-age">Time Window (min)</label>
                <input type="number" min="15" max="120" class="form-control input-sm"
                  id="input-age" placeholder="30">
              </div>
              <div class="form-group" style="padding-left:5px;padding-right:5px;">
                <label for="input-activity">Rate (pings/hour)</label>
                <input type="number" min="1" max="60"class="form-control input-sm"
                  id="input-activity" placeholder="30">
              </div>
              <button id="btn-update" type="submit"
                class="btn btn-default">Update</button>
            </form>
          </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 main">
          <div id="visual"></div>
        </div>
      </div>
    </div>
  <script>
    var base_url = "http://wifi.meyersj.com";
    var h = null;
    var w = null;
    var svg = null;
    var spacing = 40;
    var padtop = 10;
    var active = null;
    var scaled = false;
    var ACTIVE_COLOR = "#9698AA";   // grey 
    var DEFAULT_COLOR = "#1A247A";  // dark blue
    var HOVER_COLOR = "#2634AF";    // lighter blue
    
    $(document).ready(function() {
      w = $("#visual").outerWidth();
      svg = create_canvas("#visual", 100, w);
      draw(30, 30);
    });
    
    $("#btn-update").click( function(event) {
      var age = $("#input-age").val() || 30;
      var activity = $("#input-activity").val() || 30;
      event.preventDefault();
      draw(age, activity);
    });    

   
    function activate_history(mode) {
        if(mode == true) {
          scale_visits(0.8);
          svg.append("rect")
            .attr("id", "history-button")
            .attr("x", w - 190)
            .attr("y", 0)
            .attr("width", 190)
            .attr("height", 30)
            .attr("rx", 5)
            .attr("ry", 5)
            .style("fill", HOVER_COLOR)
            .on("click", function(d) {
              activate_history(false);
            });
          svg.append("text")
            .attr("id", "history-label")
            .text("Click to turn off history")
            .attr("x", w - 183)
            .attr("y", 19)
            .attr("font-size", "12px")
            .style("fill", "white");
        }
        else if(mode == false) {
          var id = "#action-" + active.replace(/:/g, '');
          change_color(id, DEFAULT_COLOR);
          scale_visits(1);
          svg.selectAll(".active-device").remove();
          svg.selectAll(".history").remove();
          svg.selectAll("#history-button").remove();
          svg.selectAll("#history-label").remove();
          active = null;
        }
    }
   

    function loading() {
      var load = ["loading "];
      for (var i = 0; i < 500; i++) load.push(".");
      
      svg.selectAll("text")
        .data(load)
        .enter()
        .append("text")
        .transition()
        .delay(function(d, i) { return i * 250; })
        .text(function(d) { return d; })
        .attr("x", function(d, i) {
          if (i > 0) return i * 15 + 110;
          else return 50;
        })
        .attr("y", 50) 
        .attr("font-size", "20px")
        .attr("text-align", "middle");

    }
    function draw(age, rate) {
      active = null;
      svg = create_canvas("#visual", h, w);
      loading(); 
      
      var args = {};
      args["location"] = "apartment";
      args["age"] = age;
      args["rate"] = rate;
      
      $.getJSON(base_url + "/visits", args, function(data) {
        var h = (data.visits.length + 1) * spacing;
        svg = create_canvas("#visual", h, w);

        var end = (new Date).getTime() / 1000;
        var start = end - (age * 60);
        var time_scale = d3.scale.linear()
          .domain([start, end])
          .range([0, w - 150]);
  
        var pings = []
        var visits = []
        var meta = []
        $(data.visits).each(function(vi, vd) {
          if(vd.data.length > 0) {
            meta.push({
              mac:vd.mac,
              manuf:vd.manuf
            })
            var y = visit_height(vi);
            visits.push([
              {x:time_scale(vd.data[0][0]), y:y},
              {x:time_scale(vd.data[vd.data.length - 1][0]), y:y}
            ]);
            $(vd.data).each(function(di, dd) {
              pings.push({group:vi, x:time_scale(dd[0]), y:y});
            });
          }
        });
        add_visit_timeline(visits);
        add_pings(pings);
        add_visit_metadata(meta);
      });
    }

    function change_color(selector, color, size) {
      d3.select(selector)
        .transition()
        .duration(50)
        .style("fill", color)
        .attr("r", size);
    }

    function create_canvas(div, height, width) {
      if(svg) svg.remove();
      return d3.select(div)
        .append("svg")
        .attr("height", height)
        .attr("width", width);
    }
    
    function visit_height(level) {
      return 20 + (level) * spacing;  
    }
    
    function display_name(mac, manuf) {
      if(manuf) return manuf + "-" + mac.substr(9, 17);
      else return mac;
    }
    
    function add_pings(pings) {
      svg.selectAll(".ping")
        .data(pings)
        .enter()
        .append("circle")
        .attr("class", "ping")
        .attr("cx", function(d) { return d.x + 150; })
        .attr("cy", function(d) { return d.y; })
        .attr("r", 3)
        .style("fill", "black");
    }
   

    //function line_function(ratio) {
    //     //}
    
    function add_visit_timeline(visits) {
      var line = d3.svg.line()
        .x(function(d, i) { return d.x + 150; })
        .y(function(d, i) { return d.y; });
      
      svg.selectAll(".visit-timeline")
        .data(visits)
        .enter()
        .append("path")
        .attr("class", "visit-timeline")
        .attr("d", function(d) { return line(d); })
        .attr("stroke", "black")
        .attr("stroke-width", 1);
    }

    function scale_visits(ratio) {
      svg.selectAll(".ping")
        .transition()
        .duration(500)
        .delay(function(d, i) { return d.group * 50; })
        .attr("cx", function(d) { return d.x * ratio + 150; })
        .attr("cy", function(d) { return d.y; })
      
      var line = d3.svg.line()
        .x(function(d, i) { return d.x * ratio + 150; })
        .y(function(d, i) { return d.y; });
      
      svg.selectAll(".visit-timeline")
        .transition()
        .duration(500)
        .delay(function(d, i) { return i * 50; })
        .attr("d", function(d) { return line(d); })
    }
    
    
    function history_label(visit, text, x, y) {
      visit.append("tspan")
        .text(text)
        .attr("x", w - 190 + x)
        .attr("y", y);
    }

    
    function add_visit_metadata(meta) {
            
      svg.selectAll(".action-box")
        .data(meta)
        .enter()
        .append("rect")
        .attr("class", "action-circle")
        .attr("id", function(d, i) { return "action-" + d.mac.replace(/:/g, ''); })
        .attr("mac", function(d) { return d.mac; })
        .attr("x", 0)
        .attr("y", function(d, i) { return visit_height(i) - 15; })
        .attr("width", 130)
        .attr("height", 30)
        .attr("rx", 5)
        .attr("ry", 5)
        .style("fill", DEFAULT_COLOR)
        .on("mouseover", function(d) {
            if(active !== d3.select(this).attr("mac"))
                change_color(this, HOVER_COLOR);
        })
        .on("mouseout", function(d) {
            if(active !== d3.select(this).attr("mac"))
                change_color(this, DEFAULT_COLOR);
        })
        .on("click", function(d, i) {
          if(!active) activate_history(true);
          var new_active = d3.select(this).attr("mac");
          change_color(this, ACTIVE_COLOR);
          if(new_active !== active) {
            if(active) {
              var id = "#action-" + active.replace(/:/g, '');
              change_color(id, DEFAULT_COLOR);
            }
            active = new_active;
          
            $.getJSON(base_url + "/visitor-history", {mac:d.mac}, function(data) {
              console.log(data);
              
              svg.selectAll(".active-device").remove();
              svg.selectAll(".history").remove();
              svg.append("text")
                .attr("class", "active-device")
                .text(display_name(d.mac, d.manuf))
                .attr("x", w - 190)
                .attr("y", visit_height(1) + 4);
              svg.selectAll(".history")
                .data(data.visits).enter()
                .append("text")
                .attr("class", "history")
                .attr("font-size", "12px")
                .each(function(vd, i) {
                  var visit = d3.select(this);
                  var level = spacing * 2 + visit_height(i * 1.5) + 4;
                  var labels = [
                    vd.datestamp,
                    vd.timerange,
                    vd.duration,
                    "pings: " + vd.activity + ", rate: " + vd.rate
                  ];
                  $(labels).each(function(index, item) {
                    history_label(visit, item, 0, (index * 12) + level);

                  });
                });
            });
          }
        });
            
        svg.selectAll(".visit-label")
          .data(meta)
          .enter()
          .append("text")
          .attr("class", "visit-label")
          .text(function(d) { return display_name(d.mac, d.manuf); })
          .attr("x", 7)
          .attr("y", function(d, i) { return visit_height(i) + 4; })
          .attr("font-size", "12px")
          .style("fill", "white");
    }



  </script>





  </body>
</html>
