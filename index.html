<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>WiFi-Location Analytics</title>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
      rel="stylesheet">
    <!-- IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  
    <style>
      .node circle {
        stroke: #fff;
        stroke-width: 2px;
      }
      .node text {
        opacity: 0;
        cursor: default;
        text-anchor: middle;
      }
      .node:hover text {
        opacity: 1;
      }
    </style>


  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
          <div id="visual"></div>
        </div>
      </div>
    </div>
  
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>

var w, h, svg, scale;
var base_url = "http://wifi.meyersj.com/api";


$(document).ready(function() {
    w = $("#visual").outerWidth();
    h = 500;
    svg = create_canvas("#visual", w, h);
    scale = build_scales();
    //var args = {mac:'18:0c:ac:ac:5f:85'};    
    var args = {unique:true};
    initialize(args);
});

function initialize(args) {
    $.getJSON(base_url + "/pings", args, function(data) {
        console.log(data);
        var force = d3.layout.force()
            .size([w, h])
            .nodes(data.data)
            .charge(-100);
        var node = build_nodes(force, data.data);
        force.on('tick', function() {
            //node.attr('x', function(d) { return d.x; })
            //    .attr('y', function(d) { return d.y; });
            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")"; 
            });
        });
        force.start();
    });
}

function build_scales() {
    return {
        duration:d3.scale.linear()
            .domain([0, 60])
            .range([7, 25]),
        age:d3.scale.pow().exponent(1/2)
            .domain([0, 60])
            .range(["blue", "white"])
    };
}

function build_nodes(force, nodes) { 
    // timestamp rounded to nearest 5 minute interval
    // less than current timestamp
    var now = Math.floor(((new Date).getTime() / 1000) / 300) * 300;
    var node = svg.selectAll('.node')
        .data(nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .call(force.drag);
    
    node.append("circle")
        .style('fill', function(d) {
            var age = (now - d.max_arrival) / 60;
            //console.log(age);
            return scale.age(age);
        })
        .attr('r', function(d) {
            var duration = (d.max_arrival - d.min_arrival) / 60;
            console.log(duration);
            return scale.duration(duration);
        });
    
    node.append("text")
        .attr("dy", 5)
        .text(function(d) {
            if(!d.manuf) return "None";
            return d.manuf;
        });
    
    return node;
}

function create_canvas(div, width, height) {
    if(svg) svg.remove();
    return d3.select(div)
        .append("svg")
        .attr("height", height)
        .attr("width", width);
}

    </script>
  </body>
</html>
